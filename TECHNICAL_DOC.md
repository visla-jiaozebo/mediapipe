# 精确人脸美颜系统 - 技术文档

## 🎯 系统概述

这是一个基于MediaPipe 468个关键点的精确人脸美颜系统，实现了区域化处理和面部塑形功能。

## 🔄 处理流程

```
输入图片
    ↓
MediaPipe人脸检测 (获取468个关键点)
    ↓
关键点坐标转换 (标准化→像素坐标)
    ↓
皮肤区域精确定位 (基于关键点创建掩码)
    ↓
┌─────────────────┬─────────────────┐
│   面部塑形      │   皮肤美化      │
│ • 大眼效果      │ • 精确磨皮      │
│ • 瘦脸处理      │ • 区域美白      │
│ • 瘦鼻优化      │ • 皮肤红润      │
└─────────────────┴─────────────────┘
    ↓
整体调节 (锐化、对比度、饱和度)
    ↓
输出精确美颜结果
```

## 🎨 核心特性

### 1. 精确区域定位
- **皮肤区域识别**: 基于关键点创建精确的皮肤掩码
- **排除保护区域**: 自动排除眼部、嘴唇、眉毛等区域
- **自适应处理**: 根据人脸大小和角度自动调整处理强度

### 2. 面部塑形算法
- **大眼效果**: 基于眼部关键点的局部放大算法
- **瘦脸处理**: 基于脸部轮廓的自然收缩变形
- **变形保护**: 避免过度变形，保持自然效果

### 3. 智能美肤技术
- **分区磨皮**: 只处理皮肤区域，保护细节特征
- **色调调节**: 针对性的美白和红润处理
- **边缘保护**: 避免处理边界产生的不自然效果

## 📊 关键点映射

### MediaPipe 468关键点分布
```
面部轮廓: 0-16 (下颌线)
右眉毛: 17-21
左眉毛: 22-26  
鼻梁: 27-35
右眼: 36-41
左眼: 42-47
嘴部: 48-67
...更多区域...
```

### 美颜区域定义
```javascript
const BEAUTY_REGIONS = {
    // 皮肤处理区域
    SKIN_AREAS: [
        "脸颊区域", "额头区域", "鼻部区域", "下巴区域"
    ],
    
    // 保护区域 (不进行磨皮)
    PROTECTED_AREAS: [
        "眼部区域", "嘴唇区域", "眉毛区域", "鼻孔区域"
    ],
    
    // 塑形重点
    RESHAPE_TARGETS: [
        "眼部中心", "脸颊轮廓", "下颌线", "鼻翼"
    ]
};
```

## 🛠️ 技术实现

### 1. 关键点处理
```javascript
// 坐标转换
function convertLandmarksToPixels(landmarks, width, height) {
    return landmarks.map(point => ({
        x: Math.floor(point.x * width),
        y: Math.floor(point.y * height),
        z: point.z || 0
    }));
}

// 区域掩码创建
function createSkinMask(src, landmarks) {
    // 1. 创建基础掩码
    // 2. 绘制皮肤区域
    // 3. 排除保护区域
    // 4. 返回精确掩码
}
```

### 2. 面部塑形
```javascript
// 大眼算法
function applyEyeEnlargement(dst, landmarks) {
    // 1. 定位眼部中心
    // 2. 计算放大区域
    // 3. 应用局部变形
    // 4. 自然过渡处理
}

// 瘦脸算法  
function applyFaceSlimming(dst, landmarks) {
    // 1. 识别脸部轮廓
    // 2. 计算收缩中心
    // 3. 应用径向变形
    // 4. 保持比例协调
}
```

### 3. 精确磨皮
```javascript
// 区域化磨皮
function applySkinRegionSmoothing(src, landmarks) {
    // 1. 创建皮肤掩码
    // 2. 高斯模糊处理
    // 3. 掩码混合应用
    // 4. 边缘过渡优化
}
```

## 🎛️ 参数说明

### 皮肤美化参数
| 参数 | 范围 | 说明 | 算法 |
|------|------|------|------|
| 精确磨皮 | 0-100 | 只处理皮肤区域的磨皮强度 | 高斯模糊+掩码混合 |
| 皮肤美白 | 0-50 | 针对皮肤区域的美白程度 | 亮度调节+区域应用 |
| 皮肤红润 | 0-30 | 增加面部皮肤红润度 | 暖色调+掩码限制 |

### 面部塑形参数
| 参数 | 范围 | 说明 | 算法 |
|------|------|------|------|
| 大眼效果 | 0-50 | 基于眼部关键点的放大 | 局部放射变形 |
| 瘦脸程度 | 0-50 | 基于脸部轮廓的收缩 | 径向收缩变形 |
| 瘦鼻效果 | 0-30 | 鼻部轮廓优化 | 定向压缩变形 |

### 整体调节参数
| 参数 | 范围 | 说明 | 算法 |
|------|------|------|------|
| 锐化强度 | 0-100 | 提升整体清晰度 | Unsharp Mask |
| 对比度 | -50~50 | 调整明暗对比 | 线性变换 |
| 饱和度 | -50~50 | 调整色彩鲜艳程度 | 色调调节 |

## 🔍 技术优势

### 1. 精确性
- ✅ 基于468个关键点的精确定位
- ✅ 像素级的区域识别和处理
- ✅ 自适应的处理强度调节

### 2. 自然性  
- ✅ 保护重要面部特征
- ✅ 避免过度处理的不自然效果
- ✅ 平滑的边缘过渡处理

### 3. 性能
- ✅ 优化的内存管理
- ✅ 高效的区域化处理算法
- ✅ 实时参数调节响应

### 4. 兼容性
- ✅ 支持现代浏览器
- ✅ 跨平台Web应用
- ✅ 无需服务器端处理

## 🚀 使用建议

### 最佳参数组合

**自然美颜模式**:
- 精确磨皮: 20-30
- 皮肤美白: 5-10  
- 大眼效果: 10-15
- 瘦脸程度: 5-10

**增强美颜模式**:
- 精确磨皮: 40-50
- 皮肤美白: 15-20
- 大眼效果: 20-25
- 瘦脸程度: 15-20

**专业摄影模式**:
- 精确磨皮: 25-35
- 锐化强度: 30-40
- 对比度: 10-15
- 瘦脸程度: 8-12

## 📝 更新日志

### v2.0.0 - 精确美颜系统
- ✨ 新增基于468关键点的精确区域识别
- ✨ 实现大眼和瘦脸塑形功能
- ✨ 优化皮肤区域磨皮算法
- ✨ 增强用户界面和参数控制
- 🐛 修复内存管理和性能问题

### v1.0.0 - 基础美颜系统
- ✨ 实现基本美颜功能
- ✨ MediaPipe人脸检测集成
- ✨ OpenCV.js图像处理

---

*基于MediaPipe和OpenCV.js的先进美颜技术 | 开源项目*
